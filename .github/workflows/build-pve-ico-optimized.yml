name: Build PVE CT Image

on:
  push:
    branches:
      - sb-docker
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Build Complete PVE CT
        run: |
          # 1. å®‰è£…ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y debootstrap zstd systemd-sysv

          # 2. åˆ›å»ºç›®å½•
          OUTPUT_DIR="$GITHUB_WORKSPACE/workspace/output"
          ROOTFS_DIR="$GITHUB_WORKSPACE/workspace/root/rootfs"
          mkdir -p "$OUTPUT_DIR" "$ROOTFS_DIR"

          # 3. åˆ›å»ºå®Œæ•´ Debian ç³»ç»Ÿï¼ˆå« systemdï¼‰
          cd "$GITHUB_WORKSPACE/workspace/root"
          sudo debootstrap --variant=minbase --include=systemd,systemd-sysv bookworm rootfs http://deb.debian.org/debian

          # 4. å®Œæ•´ç³»ç»Ÿé…ç½®
          sudo chroot "$ROOTFS_DIR" /bin/bash << 'CHROOT_EOF'
            export DEBIAN_FRONTEND=noninteractive
            
            # æ›´æ–°å¹¶å®‰è£…åŸºç¡€åŒ…
            apt-get update
            apt-get install -y --no-install-recommends \\
              ca-certificates curl wget procps openssh-server net-tools htop \\
              tzdata locales cron sudo vim iputils-ping dnsutils
            
            # é…ç½® systemd
            systemctl enable ssh
            systemctl enable cron
            
            # é…ç½®ç½‘ç»œ
            echo "nameserver 8.8.8.8" > /etc/resolv.conf
            
            # è®¾ç½® root å¯†ç 
            echo "root:changeme123" | chpasswd
            
            # é…ç½® SSH
            sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
            sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
            
            # è®¾ç½®æ—¶åŒº (UTC)
            ln -sf /usr/share/zoneinfo/UTC /etc/localtime
            dpkg-reconfigure -f noninteractive tzdata
            
            # æ¸…ç†
            apt-get clean
            rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          CHROOT_EOF

          # 5. åˆ›å»º PVE CT æ¨¡æ¿
          cd "$ROOTFS_DIR"
          sudo tar --numeric-owner --one-file-system --anchored \\
            -cf - . | zstd -19 -o "$OUTPUT_DIR/sing-box-ct.tar.zst"

          # 6. éªŒè¯å’Œå…ƒæ•°æ®
          cd "$OUTPUT_DIR"
          sha256sum sing-box-ct.tar.zst > sing-box-ct.tar.zst.sha256
          
          echo ""
          echo "ğŸ‰ PVE CT TEMPLATE READY!"
          echo "ğŸ“ Files:"
          ls -lh .
          echo ""
          echo "âœ… CONTAINS: systemd, sshd, cron, root:changeme123"
          echo "ğŸš€ PVE å‘½ä»¤: pct create 100 sing-box-ct.tar.zst --rootfs local-lvm:8"
