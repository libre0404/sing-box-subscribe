# GitHub Actions 工作流：构建 PVE CT 可用的 ICO 镜像（优化版）
name: Build PVE CT ICO Image

on:
  push:
    branches:
      - sb-docker
    paths:
      - 'Dockerfile' # 仅匹配根目录下的 Dockerfile
      - '.github/workflows/build-pve-ico.yml'
  pull_request:
    branches:
      - sb-docker
  # 允许手动触发
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (full/quick)'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # 统一管理 Dockerfile 路径，方便未来修改
  DOCKERFILE_PATH: ./Dockerfile
  # ICO 版本（用于 PVE 模板元数据）
  ICO_VERSION: 1.0

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU for multi-architecture
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (Tags and Labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch # 分支名，如 sb-docker
            type=semver,pattern={{version}} # 仅使用标准版本号
            type=sha,prefix={{branch}}- # 分支名-SHA
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }} # 使用 env 变量
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-ico-image:
    needs: build
    runs-on: ubuntu-latest
    # 仅在 sb-docker 分支上 push 时执行
    if: github.event_name == 'push' && github.ref == 'refs/heads/sb-docker'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 优化：仅安装制作 LXC 镜像所需的工具
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            qemu-utils \
            debootstrap \
            curl \
            wget \
            jq \
            zstd

      - name: Create workspace
        id: workspace
        run: |
          WORKSPACE_ROOT=${{ github.workspace }}/workspace
          mkdir -p "$WORKSPACE_ROOT"/{root,output}
          # 将工作目录路径传递给后续步骤
          echo "workspace_dir=$WORKSPACE_ROOT" >> $GITHUB_OUTPUT
          echo "Workspace created at: $(pwd)"

      - name: Download base ICO image
        id: download
        run: |
          ROOT_DIR="${{ github.workspace }}/workspace/root"
          cd "$ROOT_DIR"
          
          echo "Downloading Debian 12 base image..."
          # PVE 官方源：尝试 HTTPS (推荐) 和 HTTP
          wget -q --timeout=300 --tries=3 -O debian-12-base.tar.zst \
            https://download.proxmox.com/images/system/debian-12-standard_12.2-1_amd64.tar.zst || \
            wget -q --timeout=300 --tries=3 -O debian-12-base.tar.zst \
            http://download.proxmox.com/images/system/debian-12-standard_12.2-1_amd64.tar.zst
          
          if [ -f debian-12-base.tar.zst ]; then
            echo "✅ Base image downloaded successfully"
            echo "status=downloaded
