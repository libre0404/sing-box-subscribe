name: Build PVE CT Image

on:
  push:
    branches:
      - sb-docker
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y debootstrap wget curl jq zstd

      - name: Create rootfs
        run: |
          mkdir -p workspace/root/rootfs
          cd workspace/root
          sudo debootstrap --variant=minbase bookworm rootfs http://deb.debian.org/debian

      - name: Customize rootfs
        run: |
          cd workspace/root/rootfs
          sudo chroot . bash -c "
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -qq
            apt-get install -y ca-certificates curl wget procps openssh-server
            apt-get clean
            rm -rf /var/lib/apt/lists/*
          "

      - name: Create output directory
        run: mkdir -p workspace/output

      - name: Create tar archive
        run: |
          cd workspace/root/rootfs
          sudo tar --numeric-owner --one-file-system \
            -cf - . | pv -s $(sudo du -sb .) | \
            zstd -19 -o ../../../output/sing-box-ct.tar.zst

      - name: Verify and finalize
        run: |
          cd workspace/output
          ls -lh .
          test -f sing-box-ct.tar.zst && echo "✅ Archive created" || echo "❌ Archive failed"
          sha256sum sing-box-ct.tar.zst > sing-box-ct.tar.zst.sha256
          ls -lh .
