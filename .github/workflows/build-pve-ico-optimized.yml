name: Build PVE CT Image

on:
  push:
    branches:
      - sb-docker
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Complete PVE CT Build
        run: |
          # 1. å®‰è£…æ‰€æœ‰ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y debootstrap zstd curl wget

          # 2. åˆ›å»ºç›®å½•
          OUTPUT_DIR="$GITHUB_WORKSPACE/workspace/output"
          ROOTFS_DIR="$GITHUB_WORKSPACE/workspace/root/rootfs"
          mkdir -p "$OUTPUT_DIR" "$ROOTFS_DIR"

          # 3. åˆ›å»ºåŸºç¡€ç³»ç»Ÿ
          cd "$GITHUB_WORKSPACE/workspace/root"
          sudo debootstrap --variant=minbase bookworm rootfs http://deb.debian.org/debian

          # 4. è‡ªå®šä¹‰å®¹å™¨
          sudo chroot "$ROOTFS_DIR" bash -c "
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y ca-certificates curl wget procps openssh-server
            apt-get clean
            rm -rf /var/lib/apt/lists/*
          "

          # 5. åˆ›å»ºå‹ç¼©åŒ…
          cd "$ROOTFS_DIR"
          sudo tar --numeric-owner --one-file-system -cf - . | \
            zstd -19 -o "$OUTPUT_DIR/sing-box-ct.tar.zst"

          # 6. ç”Ÿæˆæ ¡éªŒå’Œå’Œæ˜¾ç¤ºç»“æœ
          cd "$OUTPUT_DIR"
          sha256sum sing-box-ct.tar.zst > sing-box-ct.tar.zst.sha256
          
          echo ""
          echo "ğŸ‰ BUILD COMPLETED SUCCESSFULLY!"
          echo "ğŸ“ Files in workspace/output/:"
          ls -lh .
          echo ""
          echo "ğŸ” SHA256 Checksum:"
          cat sing-box-ct.tar.zst.sha256
          echo ""
          echo "ğŸš€ PVE Import Command:"
          echo "pct create 100 '$OUTPUT_DIR/sing-box-ct.tar.zst'"
