name: Build PVE CT Image

on:
  push:
    branches:
      - sb-docker
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Build PVE CT Template
        run: |
          # 1. 创建目录
          OUTPUT_DIR="$GITHUB_WORKSPACE/workspace/output"
          ROOTFS_DIR="$GITHUB_WORKSPACE/workspace/root/rootfs"
          mkdir -p "$OUTPUT_DIR" "$ROOTFS_DIR"

          # 2. 创建基础系统
          cd "$GITHUB_WORKSPACE/workspace/root"
          sudo debootstrap --variant=minbase bookworm rootfs http://deb.debian.org/debian

          # 3. 安装必要软件
          sudo chroot "$ROOTFS_DIR" bash -c "
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y ca-certificates curl wget procps openssh-server
            apt-get clean
            rm -rf /var/lib/apt/lists/*
          "

          # 4. 创建 tar.zst (绝对路径)
          cd "$ROOTFS_DIR"
          sudo tar --numeric-owner --one-file-system -cf - . | \
            zstd -19 -o "$OUTPUT_DIR/sing-box-ct.tar.zst"

          # 5. 生成校验和
          cd "$OUTPUT_DIR"
          sha256sum sing-box-ct.tar.zst > sing-box-ct.tar.zst.sha256

          # 6. 显示结果
          echo "✅ SUCCESS!"
          echo "Files created:"
          ls -lh .
          echo "SHA256: $(cat sing-box-ct.tar.zst.sha256)"
