name: Build PVE CT Image

on:
  push:
    branches:
      - sb-docker
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }} .
          git checkout ${{ github.ref_name }}

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y debootstrap wget curl jq zstd

      - name: Create workspace
        run: |
          mkdir -p workspace/{root,output}
          cd workspace

      - name: Prepare rootfs
        run: |
          cd workspace/root
          mkdir rootfs
          sudo debootstrap --variant=minbase bookworm rootfs http://deb.debian.org/debian

      - name: Customize container
        run: |
          ROOTFS=workspace/root/rootfs
          sudo chroot "$ROOTFS" bash -c "
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -qq
            apt-get install -y ca-certificates curl wget procps openssh-server
            apt-get clean
            rm -rf /var/lib/apt/lists/*
          "

      - name: Create PVE template
        run: |
          cd workspace/root/rootfs
          sudo tar --numeric-owner --one-file-system -cf - . | \
            zstd -19 -o ../../../output/sing-box-ct.tar.zst
          cd workspace/output
          sha256sum sing-box-ct.tar.zst > sing-box-ct.tar.zst.sha256
          ls -lh .

      - name: Show results
        run: |
          echo "## Build Complete âœ…"
          echo "| File | Size |"
          echo "|------|------|"
          ls -lh workspace/output/ | awk 'NR>1 {print "|" $9 "|"$5"|" }'
