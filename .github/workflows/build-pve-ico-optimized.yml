name: Build PVE CT Image

on:
  push:
    branches:
      - sb-docker
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y debootstrap zstd

      - name: Create and customize rootfs
        run: |
          mkdir -p workspace/root/rootfs workspace/output

      - name: Debootstrap
        run: |
          cd workspace/root
          sudo debootstrap --variant=minbase bookworm rootfs http://deb.debian.org/debian

      - name: Customize rootfs
        run: |
          cd workspace/root/rootfs
          sudo chroot . bash -c "
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -qq
            apt-get install -y ca-certificates curl wget procps openssh-server
            apt-get clean
            rm -rf /var/lib/apt/lists/*
          "

      - name: Create PVE template (2-step safe method)
        run: |
          # Step 1: Create uncompressed tar first
          cd workspace/root/rootfs
          sudo tar --numeric-owner --one-file-system -cf /tmp/sing-box-ct.tar .
          
          # Step 2: Compress with absolute path
          zstd -19 --stdout /tmp/sing-box-ct.tar > workspace/output/sing-box-ct.tar.zst
          rm /tmp/sing-box-ct.tar

      - name: Finalize
        run: |
          cd workspace/output
          sha256sum sing-box-ct.tar.zst > sing-box-ct.tar.zst.sha256
          ls -lh .
          echo "âœ… Build completed successfully!"
          echo "File sizes:"
          du -h sing-box-ct.tar.zst sing-box-ct.tar.zst.sha256
