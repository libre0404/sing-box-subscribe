name: Build PVE CT ICO Image

on:
  push:
    branches:
      - sb-docker
    paths:
      - 'Dockerfile'
      - '.github/workflows/build-pve-ico.yml'
  pull_request:
    branches:
      - sb-docker
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (full/quick)'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKERFILE_PATH: ./Dockerfile
  ICO_VERSION: 1.0

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU for multi-architecture
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (Tags and Labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-ico-image:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/sb-docker'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            qemu-utils \
            debootstrap \
            curl \
            wget \
            jq \
            zstd

      - name: Create workspace
        id: workspace
        run: |
          WORKSPACE_ROOT=${{ github.workspace }}/workspace
          mkdir -p "$WORKSPACE_ROOT"/{root,output}
          echo "workspace_dir=$WORKSPACE_ROOT" >> $GITHUB_OUTPUT
          echo "Workspace created at: $(pwd)"

      - name: Download base ICO image
        id: download
        run: |
          ROOT_DIR="${{ github.workspace }}/workspace/root"
          cd "$ROOT_DIR"
          
          echo "Downloading Debian 12 base image..."
          wget -q --timeout=300 --tries=3 -O debian-12-base.tar.zst \
            https://download.proxmox.com/images/system/debian-12-standard_12.2-1_amd64.tar.zst || \
            wget -q --timeout=300 --tries=3 -O debian-12-base.tar.zst \
            http://download.proxmox.com/images/system/debian-12-standard_12.2-1_amd64.tar.zst
          
          if [ -f debian-12-base.tar.zst ]; then
            echo "✅ Base image downloaded successfully"
            echo "status=downloaded" >> $GITHUB_OUTPUT
          else
            echo "⚠️ Download failed, will use debootstrap instead"
            echo "status=debootstrap" >> $GITHUB_OUTPUT
          fi

      - name: Prepare container rootfs
        id: rootfs
        run: |
          ROOT_DIR="${{ github.workspace }}/workspace/root"
          ROOTFS="$ROOT_DIR/rootfs"
          mkdir -p "$ROOTFS"
          
          if [ "${{ steps.download.outputs.status }}" == "debootstrap" ]; then
            echo "Creating rootfs with debootstrap..."
            sudo debootstrap --variant=minbase --no-check-gpg \
              bookworm "$ROOTFS" http://deb.debian.org/debian
          else
            echo "Extracting base image..."
            sudo tar -xf "$ROOT_DIR/debian-12-base.tar.zst" -C "$ROOTFS"
          fi
          
          echo "rootfs_path=$ROOTFS" >> $GITHUB_OUTPUT
          echo "✅ Rootfs prepared"
          sudo ls -la "$ROOTFS" | head -10

      - name: Customize container
        run: |
          ROOTFS="${{ steps.rootfs.outputs.rootfs_path }}"
          
          if [ -f .github/scripts/customize-container.sh ]; then
            echo "Running customization script..."
            chmod +x .github/scripts/customize-container.sh
            sudo bash .github/scripts/customize-container.sh "$ROOTFS"
          else
            echo "No customize script found, using defaults"
            sudo chroot "$ROOTFS" bash -c '
              export DEBIAN_FRONTEND=noninteractive
              apt-get update -qq
              apt-get install -y --no-install-recommends \
                ca-certificates \
                curl \
                wget \
                procps \
                systemd \
                openssh-server
              apt-get clean
              rm -rf /var/lib/apt/lists/*
            '
          fi
          
          echo "✅ Container customization completed"

      - name: Create TAR archive for PVE
        id: archive
        run: |
          OUTPUT_DIR="${{ github.workspace }}/
